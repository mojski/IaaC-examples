# based on https://www.atlantic.net/vps-hosting/how-to-install-consul-server-on-ubuntu/
- name: install consul single instance
  hosts: servers
  tasks:
    - name: update apt
      become: yes
      ansible.builtin.command: |
        apt update
    
    - name: Install unzip gnupg2 curl wget
      become: yes
      ansible.builtin.apt:
        name:
          - unzip
          - gnupg2
          - curl
          - wget
        state: present
        update_cache: yes

    - name: Download consul release
      ansible.builtin.get_url:
        url: "{{consul_release}}"
        dest: /tmp/{{consul_zip_file}}

    - name: Extract
      ansible.builtin.unarchive:
        src: /tmp/{{consul_zip_file}}
        dest: /tmp/
        remote_src: yes

    - name: Move binaries
      ansible.builtin.command: >
        mv /tmp/{{consul_file}} /usr/local/bin/
      become: yes

    - name: Create consul group
      become: yes
      ansible.builtin.group:
        name: "{{ consul_group }}"
        state: present

    - name: Create consul user
      become: yes
      ansible.builtin.user:
        name: "{{ consul_user }}"
        group: "{{ consul_group }}"
        state: present
        createhome: yes
        home: /home/{{ consul_user }}
        shell: /bin/bash

    - name: Create directories
      become: yes
      ansible.builtin.file:
        dest: "{{ item }}"
        state: directory
      with_items:
        - /var/lib/consul
        - /etc/consul.d

    - name: Copy consul systemd service file
      become: yes
      ansible.builtin.copy:
        src: ./files/consul.service
        dest: /etc/systemd/system/

    - name: Reload systemd
      become: yes
      ansible.builtin.systemd:
        daemon_reload: yes

    - name: Copy consul config file
      become: yes
      ansible.builtin.copy:
        src: ./files/config.json
        dest: /etc/consul.d/config.json

    - name: Set secret
      become: yes
      ansible.builtin.lineinfile:
        path: /etc/consul.d/config.json
        regexp: '"encrypt": "key"'
        line: '"encrypt": "{{consul_encrypt_key}}"'

    - name: Change owner for created directories and files
      become: yes
      ansible.builtin.file:
        path: "{{ item }}"
        owner: "{{ consul_user }}"
        group: "{{ consul_group }}"
        mode: '755'
      with_items:
        - /var/lib/consul
        - /etc/consul.d
        - /etc/consul.d/config.json

    # TODO finish configuration
    - name: Start and enable consul service
      become: yes
      ansible.builtin.systemd:
        name: consul
        enabled: yes
        state: started