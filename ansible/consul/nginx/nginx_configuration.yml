# based on https://www.atlantic.net/vps-hosting/how-to-install-consul-server-on-ubuntu/  (Step 4)
- name: install certbot and secure basic
  hosts: "servers"
  tasks:
    - name: check nginx install
      ansible.builtin.command: which nginx
      register: nginx_installed
      ignore_errors: true

    - name: exit if there is no nginx on server
      ansible.builtin.fail:
        msg: "Nginx is not installed run nginx install playbook first, or install nginx manually"
      when: nginx_installed.rc != 0

    - name: copy nginx config file
      ansible.builtin.copy:
        src: /files/consul.conf
        dest: /etc/nginx/sites-available/consul.conf
    
    - name: link conf file
      ansible.builtin.command: >
        ln -s /etc/nginx/sites-available/consul.conf /etc/nginx/sites-enabled/
      become: true

    - name: restart nginx
      ansible.builtin.systemd:
        name: nginx
        enabled: yes
        state: restarted